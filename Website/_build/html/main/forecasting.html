
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Forecasting &#8212; Walmart Sales Forecasting</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'main/forecasting';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="About This Project" href="../about/about.html" />
    <link rel="prev" title="Analysis" href="analysis.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../home.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo2.png" class="logo__image only-light" alt="Walmart Sales Forecasting - Home"/>
    <script>document.write(`<img src="../_static/logo2.png" class="logo__image only-dark" alt="Walmart Sales Forecasting - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Summary</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../summary/introduction.html">Introduction</a></li>

<li class="toctree-l1"><a class="reference internal" href="../summary/summary.html">Results and Conclusions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysis and Forecasting</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="analysis.html">Analysis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Forecasting</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../about/about.html">About This Project</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/joshiaditya0511/walmart-sales-forecasting" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/main/forecasting.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Forecasting</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#importing-libraries-and-dataset">Importing Libraries and Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">Methodology</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling">Modeling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">Evaluation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#different-models">Different models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#saving-and-or-loading-previous-results">Saving and/or loading previous results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-and-eval-split">Train, Test and Eval split</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-metric">Loss metric</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">Data Preparation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-training">Model Training</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#holt-winters">Holt Winters</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-errors">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-predictions">Visualize predictions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arima">ARIMA</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Visualize Predictions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#xgboost">XGBoost</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#separate-train-test-split-and-growing-windows">Separate train test split and growing windows</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Visualize Predictions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fb-prophet">FB Prophet</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Separate train test split and growing windows</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Visualize Predictions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sarima">SARIMA</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Separate train test split and growing windows</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Visualize Predictions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-comparison">Model Comparison</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-forecast">Final Forecast</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#final-training">Final Training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#error-analysis">Error Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-of-results">Visualization of Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Observations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todo">ToDo</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="forecasting">
<h1>Forecasting<a class="headerlink" href="#forecasting" title="Link to this heading">#</a></h1>
<section id="importing-libraries-and-dataset">
<h2>Importing Libraries and Dataset<a class="headerlink" href="#importing-libraries-and-dataset" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="c1"># import seaborn as sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tsa.holtwinters</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExponentialSmoothing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tsa.arima.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">ARIMA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tsa.statespace.sarimax</span><span class="w"> </span><span class="kn">import</span> <span class="n">SARIMAX</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xgboost</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xgb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prophet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Prophet</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../Stationary/Data/walmart.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">cleaning</span><span class="p">(</span><span class="n">df_copy</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%Y&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Store&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Store&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Holiday_Flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Holiday_Flag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">BooleanDtype</span><span class="p">())</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">cleaning</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="methodology">
<h2>Methodology<a class="headerlink" href="#methodology" title="Link to this heading">#</a></h2>
<section id="data">
<h3>Data<a class="headerlink" href="#data" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Source:</strong><br />
The data for this analysis is from <a class="reference external" href="https://www.kaggle.com/datasets/rutuspatel/walmart-dataset-retail">Kaggle</a>.</p></li>
<li><p><strong>Content:</strong><br />
The dataset contains weekly sales for 45 Walmart stores covering the years 2010 to 2012.</p></li>
<li><p><strong>Forecasting Strategy:</strong><br />
Since sales patterns differ across stores, forecasts will be developed separately for each store.</p></li>
</ul>
</section>
<section id="modeling">
<h3>Modeling<a class="headerlink" href="#modeling" title="Link to this heading">#</a></h3>
<p>The following models were explored for forecasting:</p>
<ol class="arabic simple">
<li><p>Holt-Winters Exponential Smoothing</p></li>
<li><p>ARIMA</p></li>
<li><p>ARIMAX</p></li>
<li><p>SARIMA</p></li>
<li><p>SARIMAX</p></li>
<li><p>FB Prophet</p></li>
<li><p>XGBoost</p></li>
</ol>
</section>
<section id="training">
<h3>Training<a class="headerlink" href="#training" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Data Length:</strong><br />
Each store has 143 weeks of sales data. Our goal is to generate forecasts for the next 12 weeks.</p></li>
<li><p><strong>Hold-Out Period:</strong><br />
The last 12 weeks are set aside as a hold-out “forecast” period.</p></li>
<li><p><strong>Training and Validation Split:</strong><br />
The remaining 131 weeks are used for model development. To capture seasonal effects—especially because of yearly patterns—the first 105 weeks (over 2 full years) serve as our initial training set. The following 26 weeks are used as a validation period.</p></li>
<li><p><strong>Model Development:</strong></p>
<ul>
<li><p>For time series models (ARIMA, SARIMA, and SARIMAX), we train multiple candidate models with different orders on the 105-week training data. Information criteria (Akaike Information Criterion, AIC) are used to choose the best orders for each of these models.</p></li>
<li><p>For XGBoost and FB Prophet, several hyperparameter configurations (e.g., max depth, learning rate, changepoint sensitivity) are initially considered, but we do not use AIC/BIC for these models.</p></li>
</ul>
</li>
</ul>
</section>
<section id="evaluation">
<h3>Evaluation<a class="headerlink" href="#evaluation" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Metric:</strong><br />
Although each model optimizes its own internal loss, we use Mean Absolute Error (MAE) as our common metric to compare performance.</p></li>
<li><p><strong>Growing Window Forecasting:</strong><br />
For the 26-week validation period, we simulate a real-world forecasting scenario using a growing window approach. Specifically:</p>
<ul>
<li><p>The model predicts one week ahead.</p></li>
<li><p>After each prediction, the actual value is added to the training set.</p></li>
<li><p>This process repeats until forecasts have been made for the entire 26-week period.</p></li>
</ul>
</li>
<li><p><strong>Model Selection:</strong><br />
The candidate model with the lowest average MAE over the validation windows is chosen as the best model.</p></li>
<li><p><strong>Final Forecast:</strong><br />
Once the best model is identified, it is re-trained on the full 131 weeks (the original training plus validation periods). Finally, this retrained model is used to forecast the reserved 12 weeks.</p></li>
</ul>
</section>
</section>
<section id="different-models">
<h2>Different models<a class="headerlink" href="#different-models" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Holt Winters i.e. Triple Exponential Smoothing</p></li>
<li><p>ARIMA with orders</p>
<ul class="simple">
<li><p>(6, 1, 4)</p></li>
<li><p>(6, 1, 5)</p></li>
<li><p>(6, 2, 4)</p></li>
<li><p>(6, 2, 5)</p></li>
<li><p>(9, 2, 4)</p></li>
<li><p>(9, 2, 5)</p></li>
</ul>
</li>
<li><p>SARIMA with orders</p>
<ul class="simple">
<li><p>(6, 1, 4), (2, 1, 5, 52)</p></li>
<li><p>(6, 1, 5), (2, 1, 5, 52)</p></li>
<li><p>(6, 2, 4), (2, 1, 5, 52)</p></li>
<li><p>(6, 2, 5), (2, 1, 5, 52)</p></li>
<li><p>(9, 2, 4), (2, 1, 5, 52)</p></li>
<li><p>(9, 2, 5), (2, 1, 5, 52)</p></li>
</ul>
</li>
<li><p>SARIMAX with cpi, holiday_flag and orders</p>
<ul class="simple">
<li><p>(6, 1, 4), (2, 1, 5, 52)</p></li>
<li><p>(6, 1, 5), (2, 1, 5, 52)</p></li>
<li><p>(6, 2, 4), (2, 1, 5, 52)</p></li>
<li><p>(6, 2, 5), (2, 1, 5, 52)</p></li>
<li><p>(9, 2, 4), (2, 1, 5, 52)</p></li>
<li><p>(9, 2, 5), (2, 1, 5, 52)</p></li>
</ul>
</li>
<li><p>XGBoost with</p>
<ul class="simple">
<li><p>month</p></li>
<li><p>year</p></li>
<li><p>holiday_flag</p></li>
<li><p>CPI</p></li>
<li><p>lagged sales</p></li>
</ul>
</li>
<li><p>FB Prophet</p></li>
</ol>
</section>
<section id="saving-and-or-loading-previous-results">
<h2>Saving and/or loading previous results<a class="headerlink" href="#saving-and-or-loading-previous-results" title="Link to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">custom_encoder</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom encoder that converts non-serializable objects into a</span>
<span class="sd">    serializable format with type markers. Now handles NumPy arrays,</span>
<span class="sd">    tuples, and pandas Timestamp objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;__ndarray__&quot;</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;__tuple__&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">o</span><span class="p">)}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;__pdtimestamp__&quot;</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()}</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not JSON serializable&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">custom_decoder</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks for type markers in the dictionary and converts them back</span>
<span class="sd">    to their original types. Now converts the pandas Timestamp marker</span>
<span class="sd">    back to a pd.Timestamp object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;__ndarray__&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;__ndarray__&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;__tuple__&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;__tuple__&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;__pdtimestamp__&quot;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;__pdtimestamp__&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_all_results</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="s2">&quot;results.json&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the full results dictionary from file using custom_decoder.</span>
<span class="sd">    If the file does not exist, returns an empty dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">custom_decoder</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
    <span class="k">return</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">save_all_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="s2">&quot;results.json&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the full results dictionary to file using custom_encoder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">custom_encoder</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="train-test-and-eval-split">
<h2>Train, Test and Eval split<a class="headerlink" href="#train-test-and-eval-split" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get sorted unique dates</span>
<span class="n">unique_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">total_weeks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_dates</span><span class="p">)</span>

<span class="c1"># Reserve final 12 weeks for hold-out (final forecast)</span>
<span class="n">holdout_dates</span> <span class="o">=</span> <span class="n">unique_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">12</span><span class="p">:]</span>

<span class="c1"># The remaining weeks (training + validation): should be total_weeks - 12.</span>
<span class="n">train_val_dates</span> <span class="o">=</span> <span class="n">unique_dates</span><span class="p">[:</span><span class="o">-</span><span class="mi">12</span><span class="p">]</span>

<span class="c1"># Split the 131 weeks: the first 105 weeks for training and the next 26 weeks for validation</span>
<span class="n">train_dates</span> <span class="o">=</span> <span class="n">train_val_dates</span><span class="p">[:</span><span class="mi">105</span><span class="p">]</span>
<span class="n">val_dates</span> <span class="o">=</span> <span class="n">train_val_dates</span><span class="p">[</span><span class="mi">105</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="loss-metric">
<h2>Loss metric<a class="headerlink" href="#loss-metric" title="Link to this heading">#</a></h2>
</section>
<section id="data-preparation">
<h2>Data Preparation<a class="headerlink" href="#data-preparation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the unique store identifiers (assuming &#39;store&#39; is categorical)</span>
<span class="n">stores</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Create a results dictionary to store individual store results, and later aggregated metrics</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">load_all_results</span><span class="p">()</span>

<span class="c1"># We will forecast in 2-week horizons over the 26 validation weeks.</span>
<span class="n">forecast_horizon</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_forecast_iterations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)</span> <span class="o">//</span> <span class="n">forecast_horizon</span>  <span class="c1"># should be 26/2 = 13</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-training">
<h2>Model Training<a class="headerlink" href="#model-training" title="Link to this heading">#</a></h2>
<section id="holt-winters">
<h3>Holt Winters<a class="headerlink" href="#holt-winters" title="Link to this heading">#</a></h3>
<section id="id1">
<h4>Training<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;HoltWinters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;HoltWinters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;store_results&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;aggregated_metrics&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

<span class="c1"># Loop over each store</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="c1"># Filter the store’s data and sort it by date.</span>
    <span class="n">store_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">store</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Split the store data into training and validation sets based on date.</span>
    <span class="n">train_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_dates</span><span class="p">)]</span>
    <span class="n">valid_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)]</span>
    
    <span class="c1"># Extract the weekly sales series (using &#39;date&#39; as index)</span>
    <span class="n">train_series</span> <span class="o">=</span> <span class="n">train_store_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">]</span>
    
    <span class="c1"># Initialize lists to collect forecasts and actual values as we do a growing-window forecast.</span>
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">forecast_dates_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Start with the training series; as we move forward, this will grow.</span>
    <span class="n">series_gw</span> <span class="o">=</span> <span class="n">train_series</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Iterate over each 2-week forecast window</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_forecast_iterations</span><span class="p">):</span>
        <span class="c1"># Fit the Holt–Winters (triple exponential smoothing) model:</span>
        <span class="c1"># We assume an additive trend and additive seasonal component with season_length 52.</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            
            <span class="n">model</span> <span class="o">=</span> <span class="n">ExponentialSmoothing</span><span class="p">(</span>
                <span class="n">series_gw</span><span class="p">,</span>
                <span class="n">trend</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span>
                <span class="n">seasonal</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span>
                <span class="n">seasonal_periods</span><span class="o">=</span><span class="mi">52</span><span class="p">,</span>
                <span class="n">initialization_method</span><span class="o">=</span><span class="s2">&quot;estimated&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">optimized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_brute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Forecast the next &#39;forecast_horizon&#39; weeks</span>
            <span class="n">forecast</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">forecast_horizon</span><span class="p">)</span>
        
        <span class="c1"># Determine the forecast dates from our validation dates.</span>
        <span class="c1"># For each iteration, select the next 2 weeks in order.</span>
        <span class="n">fc_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_dates</span> <span class="o">=</span> <span class="n">val_dates</span><span class="p">[</span><span class="n">fc_start</span><span class="p">:</span><span class="n">fc_end</span><span class="p">]</span>
        
        <span class="c1"># Get the actual weekly sales for the forecast dates from the validation set.</span>
        <span class="n">valid_series</span> <span class="o">=</span> <span class="n">valid_store_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">]</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">valid_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fc_dates</span><span class="p">]</span>
        
        <span class="c1"># Append these forecasts and actuals to our lists.</span>
        <span class="n">store_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">forecast</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">store_actuals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">forecast_dates_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fc_dates</span><span class="p">)</span>
        
        <span class="c1"># Update the growing window: as if we received these observations.</span>
        <span class="c1"># (Using pd.concat instead of .append to avoid deprecation warnings.)</span>
        <span class="n">series_gw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">series_gw</span><span class="p">,</span> <span class="n">actual</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    
    <span class="c1"># After finishing the growing window forecast, compute rmse for the store.</span>
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">,</span> <span class="n">store_predictions</span><span class="p">))</span>
    
    <span class="c1"># Save results for this store.</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;HoltWinters&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;forecast_dates&#39;</span><span class="p">:</span> <span class="n">forecast_dates_list</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">store_predictions</span><span class="p">,</span>
        <span class="s1">&#39;actuals&#39;</span><span class="p">:</span> <span class="n">store_actuals</span><span class="p">,</span>
        <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">store_mae</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="calculate-errors">
<h4>Calculate Errors<a class="headerlink" href="#calculate-errors" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_mae</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;HoltWinters&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">][</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
    <span class="n">all_mae</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_mae</span><span class="p">)</span>

<span class="n">avg_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>
<span class="n">std_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>

<span class="n">results</span><span class="p">[</span><span class="s1">&#39;HoltWinters&#39;</span><span class="p">][</span><span class="s1">&#39;aggregated_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;avg_mae&#39;</span><span class="p">:</span> <span class="n">avg_mae</span><span class="p">,</span>
    <span class="s1">&#39;std_mae&#39;</span><span class="p">:</span> <span class="n">std_mae</span>
<span class="p">}</span>

<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_mae</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count        45.000000
mean      42961.345915
std       26876.922926
min        9307.971428
25%       23044.419884
50%       37918.606065
75%       59191.844352
max      126763.135885
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_all_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualize-predictions">
<h4>Visualize predictions<a class="headerlink" href="#visualize-predictions" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize dictionaries to aggregate forecast values by date.</span>
<span class="n">pred_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">actual_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># Loop through each store&#39;s results</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="n">store_result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;HoltWinters&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">actual</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;forecast_dates&#39;</span><span class="p">],</span>
                                  <span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">],</span>
                                  <span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;actuals&#39;</span><span class="p">]):</span>
        <span class="c1"># Convert dt into a pd.Timestamp (if not already)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>

<span class="c1"># Sort the forecasted dates</span>
<span class="n">sorted_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pred_by_date</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># For each date, compute the average predicted and actual weekly sales.</span>
<span class="n">avg_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>
<span class="n">avg_actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>

<span class="c1"># Plot the actual vs. predicted average sales</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_actual</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Average Sales&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_pred</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted Average Sales (HoltWinters)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weekly Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparison of Actual vs. Predicted Average Sales</span><span class="se">\n</span><span class="s2">(Validation Period)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/b6b7de6591ba2777e47dc5a6cefd964717e1d231b39937b7d3762d2b4ea4fa03.png" src="../_images/b6b7de6591ba2777e47dc5a6cefd964717e1d231b39937b7d3762d2b4ea4fa03.png" />
</div>
</div>
</section>
</section>
<section id="arima">
<h3>ARIMA<a class="headerlink" href="#arima" title="Link to this heading">#</a></h3>
<section id="id2">
<h4>Training<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">load_all_results</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;ARIMA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ARIMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;store_results&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;aggregated_metrics&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

<span class="c1"># Define candidate ARIMA orders to consider</span>
<span class="n">candidate_orders</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>

<span class="c1"># Get unique stores (assuming the store column is categorical)</span>
<span class="n">stores</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Loop over each store</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="c1"># Filter the store’s data and sort by date</span>
    <span class="n">store_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">store</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Split the data into training and validation based on date.</span>
    <span class="n">train_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_dates</span><span class="p">)]</span>
    <span class="n">valid_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)]</span>
    
    <span class="c1"># Extract the weekly sales series from training data.</span>
    <span class="n">train_series</span> <span class="o">=</span> <span class="n">train_store_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">]</span>
    
    <span class="c1"># First, determine the best ARIMA order by fitting each candidate on just the</span>
    <span class="c1"># training portion (105 weeks) and comparing their AIC.</span>
    <span class="n">best_aic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_order</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">aic_bic</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;aic&#39;</span><span class="p">,</span> <span class="s1">&#39;bic&#39;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_orders</span><span class="p">))))</span> 
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidate_orders</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Suppress warnings during the ARIMA fitting</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">train_series</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
                <span class="n">fit_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
                <span class="n">aic_bic</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
                <span class="n">aic_bic</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;aic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">aic</span>
                <span class="n">aic_bic</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;bic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">bic</span>
                <span class="c1"># print(f&quot;For store {store}, order {order}, AIC: {fit_model.aic}, BIC: {fit_model.bic}&quot;)</span>
            <span class="k">if</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">aic</span> <span class="o">&lt;</span> <span class="n">best_aic</span><span class="p">:</span>
                <span class="n">best_aic</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">aic</span>
                <span class="n">best_order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Store </span><span class="si">{</span><span class="n">store</span><span class="si">}</span><span class="s2">, order </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
    
    <span class="c1"># Now, using the selected best_order, do a growing-window forecast on the</span>
    <span class="c1"># 26-week validation set (forecasting 2 weeks at a time).</span>
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">forecast_dates_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Start the growing window with the training series.</span>
    <span class="n">series_gw</span> <span class="o">=</span> <span class="n">train_series</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># The number of forecast iterations (26 weeks / 2 per iteration).</span>
    <span class="n">n_forecast_iterations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)</span> <span class="o">//</span> <span class="n">forecast_horizon</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_forecast_iterations</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">model_gw</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">series_gw</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">best_order</span><span class="p">)</span>
                <span class="n">fit_gw</span> <span class="o">=</span> <span class="n">model_gw</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="n">forecast_result</span> <span class="o">=</span> <span class="n">fit_gw</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">forecast_horizon</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Store </span><span class="si">{</span><span class="n">store</span><span class="si">}</span><span class="s2">: Forecast iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># If forecasting fails, you can choose to assign missing values.</span>
            <span class="n">forecast_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">forecast_horizon</span><span class="p">,</span> <span class="n">series_gw</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
        <span class="c1"># Identify the forecast dates (next 2 weeks from the validation list)</span>
        <span class="n">fc_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_dates</span> <span class="o">=</span> <span class="n">val_dates</span><span class="p">[</span><span class="n">fc_start</span><span class="p">:</span><span class="n">fc_end</span><span class="p">]</span>
        
        <span class="c1"># Get the actual values for these forecast dates</span>
        <span class="n">valid_series</span> <span class="o">=</span> <span class="n">valid_store_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">]</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">valid_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fc_dates</span><span class="p">]</span>
    
        <span class="c1"># Append predictions, actuals, and forecast dates</span>
        <span class="n">store_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">forecast_result</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">forecast_result</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">forecast_result</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">store_actuals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">forecast_dates_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fc_dates</span><span class="p">)</span>
    
        <span class="c1"># Grow the training window with the actual observations just forecasted.</span>
        <span class="n">series_gw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">series_gw</span><span class="p">,</span> <span class="n">actual</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    
    <span class="c1"># After finishing the growing window forecast, compute rmse for the store.</span>
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">,</span> <span class="n">store_predictions</span><span class="p">))</span>
    
    <span class="c1"># Save results for this store.</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ARIMA&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;best_order&#39;</span><span class="p">:</span> <span class="n">best_order</span><span class="p">,</span>
        <span class="s1">&#39;forecast_dates&#39;</span><span class="p">:</span> <span class="n">forecast_dates_list</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">store_predictions</span><span class="p">,</span>
        <span class="s1">&#39;actuals&#39;</span><span class="p">:</span> <span class="n">store_actuals</span><span class="p">,</span>
        <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">store_mae</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Store 38: Forecast iteration 15 failed with error: LU decomposition error.
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4>Calculate Errors<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_mae</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ARIMA&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">][</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
    <span class="n">all_mae</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_mae</span><span class="p">)</span>

<span class="n">avg_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>
<span class="n">std_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>

<span class="n">results</span><span class="p">[</span><span class="s1">&#39;ARIMA&#39;</span><span class="p">][</span><span class="s1">&#39;aggregated_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;avg_mae&#39;</span><span class="p">:</span> <span class="n">avg_mae</span><span class="p">,</span>
    <span class="s1">&#39;std_mae&#39;</span><span class="p">:</span> <span class="n">std_mae</span>
<span class="p">}</span>

<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_mae</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count        45.000000
mean      55857.767171
std       31973.065994
min        8107.999214
25%       32722.058617
50%       50691.990753
75%       85070.740653
max      128366.846170
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_all_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h4>Visualize Predictions<a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll collect forecasted predictions and actuals per date across all stores.</span>
<span class="n">pred_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">actual_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="n">store_result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ARIMA&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">act</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;forecast_dates&#39;</span><span class="p">],</span>
                             <span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">],</span>
                             <span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;actuals&#39;</span><span class="p">]):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>

<span class="c1"># Sort the forecasted dates</span>
<span class="n">sorted_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pred_by_date</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># Calculate the average predicted and actual sales across stores for each date.</span>
<span class="n">avg_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>
<span class="n">avg_actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>

<span class="c1"># Plot the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_actual</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Average Sales&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_pred</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted Average Sales (ARIMA)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weekly Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ARIMA Model: Actual vs. Predicted Average Weekly Sales</span><span class="se">\n</span><span class="s2">(Validation Period)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/786a56165bce6db3d3ac647f0608de4460cccee4b16d478a5b6ff3d747f04f87.png" src="../_images/786a56165bce6db3d3ac647f0608de4460cccee4b16d478a5b6ff3d747f04f87.png" />
</div>
</div>
</section>
</section>
<section id="xgboost">
<h3>XGBoost<a class="headerlink" href="#xgboost" title="Link to this heading">#</a></h3>
<section id="separate-train-test-split-and-growing-windows">
<h4>Separate train test split and growing windows<a class="headerlink" href="#separate-train-test-split-and-growing-windows" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split the 131 weeks: the first 105 weeks for training and the next 26 weeks for validation</span>
<span class="n">train_dates</span> <span class="o">=</span> <span class="n">train_val_dates</span><span class="p">[:</span><span class="mi">105</span><span class="p">]</span>
<span class="n">val_dates</span> <span class="o">=</span> <span class="n">train_val_dates</span><span class="p">[</span><span class="mi">105</span><span class="p">:]</span>

<span class="c1"># We will forecast in 4-week horizons over the 20 validation weeks.</span>
<span class="n">forecast_horizon</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_forecast_iterations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)</span> <span class="o">//</span> <span class="n">forecast_horizon</span>  <span class="c1"># should be 20/2 = 10</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h4>Training<a class="headerlink" href="#id5" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_features</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">include_diffs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;holiday_flag_int&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;holiday_flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="c1"># Create lag features</span>
    <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;sales_lag_</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">periods</span> <span class="o">=</span> <span class="n">lag</span><span class="p">)</span>
    
    <span class="c1"># Create difference features if required.</span>
    <span class="k">if</span> <span class="n">include_diffs</span><span class="p">:</span>
        <span class="c1"># First-order difference: difference between consecutive weekly_sales</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sales_diff_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Second-order difference: difference of first differences (or equivalently</span>
        <span class="c1"># the two-period difference)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sales_diff_2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Drop rows with missing values due to lag / difference calculation.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">load_all_results</span><span class="p">()</span>

<span class="k">if</span> <span class="s1">&#39;XGBoost&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;XGBoost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;store_results&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;aggregated_metrics&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

<span class="c1"># Assume stores are available from the categorical &#39;store&#39; column.</span>
<span class="n">stores</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Define lag values. (These are used in addition to our newly added difference features.)</span>
<span class="n">lag_features</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="c1"># Filter and sort the data for the current store.</span>
    <span class="n">store_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">store</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Split the store&#39;s data into training (105 weeks) and validation (26 weeks).</span>
    <span class="n">train_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_dates</span><span class="p">)]</span>
    <span class="n">valid_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)]</span>
    
    <span class="c1"># Start the growing window with the training data.</span>
    <span class="n">data_gw</span> <span class="o">=</span> <span class="n">train_store_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data_gw</span> <span class="o">=</span> <span class="n">data_gw</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Lists to hold forecasts/actuals for the current store.</span>
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">forecast_dates_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Calculate the number of iterations based on the forecast horizon.</span>
    <span class="n">n_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)</span> <span class="o">//</span> <span class="n">forecast_horizon</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
        <span class="c1"># --- TRAINING STEP ---</span>
        <span class="c1"># Build the training features using the helper function (includes diffs).</span>
        <span class="n">train_feats</span> <span class="o">=</span> <span class="n">create_features</span><span class="p">(</span><span class="n">data_gw</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">lag_features</span><span class="p">,</span> <span class="n">include_diffs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Define the feature set.</span>
        <span class="c1"># Calendar features, holiday_flag, CPI, lags, and differences.</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">train_feats</span><span class="p">[[</span>
            <span class="s2">&quot;month&quot;</span><span class="p">,</span>
            <span class="s2">&quot;year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;holiday_flag_int&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cpi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sales_lag_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sales_lag_2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sales_lag_3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sales_lag_4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sales_lag_5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sales_lag_6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sales_diff_1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sales_diff_2&quot;</span>
        <span class="p">]]</span>
        <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_feats</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span>
        
        <span class="c1"># Train the XGBoost model. Adjust hyperparameters as needed.</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBRegressor</span><span class="p">(</span>
            <span class="n">objective</span><span class="o">=</span><span class="s2">&quot;reg:squarederror&quot;</span><span class="p">,</span>
            <span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.075</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        
        <span class="c1"># --- FORECASTING STEP ---</span>
        <span class="c1"># Determine forecast dates for the current window (next 2 weeks).</span>
        <span class="n">fc_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_dates</span> <span class="o">=</span> <span class="n">val_dates</span><span class="p">[</span><span class="n">fc_start</span><span class="p">:</span><span class="n">fc_end</span><span class="p">]</span>
        
        <span class="n">fc_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fc_date</span> <span class="ow">in</span> <span class="n">fc_dates</span><span class="p">:</span>
            <span class="c1"># Extract calendar and economic features from the validation set.</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">valid_store_df</span><span class="p">[</span><span class="n">valid_store_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fc_date</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">holiday_flag_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;holiday_flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">CPI_val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;cpi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># --- Compute lag features from data_gw ---</span>
            <span class="c1"># Ensure we have enough observations to compute both lag and difference features.</span>
            <span class="n">sales_lag_1</span> <span class="o">=</span> <span class="n">data_gw</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sales_lag_2</span> <span class="o">=</span> <span class="n">data_gw</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#if len(data_gw) &gt;= 2 else sales_lag_1</span>
            <span class="n">sales_lag_3</span> <span class="o">=</span> <span class="n">data_gw</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">sales_lag_4</span> <span class="o">=</span> <span class="n">data_gw</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="c1">#if len(data_gw) &gt;= 2 else sales_lag_1</span>
            <span class="n">sales_lag_5</span> <span class="o">=</span> <span class="n">data_gw</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">sales_lag_6</span> <span class="o">=</span> <span class="n">data_gw</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="c1">#if len(data_gw) &gt;= 2 else sales_lag_1</span>
            
            <span class="c1"># Compute first difference feature</span>
            <span class="n">sales_diff_1</span> <span class="o">=</span> <span class="n">sales_lag_1</span> <span class="o">-</span> <span class="n">sales_lag_2</span>
            
            <span class="c1"># For the second difference, we need the third most recent data point.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_gw</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># sales_lag_3 = data_gw[&quot;weekly_sales&quot;].iloc[-3]</span>
                <span class="n">sales_diff_2</span> <span class="o">=</span> <span class="n">sales_lag_1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sales_lag_2</span> <span class="o">+</span> <span class="n">sales_lag_3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sales_diff_2</span> <span class="o">=</span> <span class="n">sales_diff_1</span>  <span class="c1"># Fallback if not enough data</span>
            
            <span class="c1"># Construct a DataFrame for this forecast sample.</span>
            <span class="n">X_fc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">month</span><span class="p">],</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">year</span><span class="p">],</span>
                <span class="s2">&quot;holiday_flag_int&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">holiday_flag_int</span><span class="p">],</span>
                <span class="s2">&quot;cpi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">CPI_val</span><span class="p">],</span>
                <span class="s2">&quot;sales_lag_1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">sales_lag_1</span><span class="p">],</span>
                <span class="s2">&quot;sales_lag_2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">sales_lag_2</span><span class="p">],</span>
                <span class="s2">&quot;sales_lag_3&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">sales_lag_3</span><span class="p">],</span>
                <span class="s2">&quot;sales_lag_4&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">sales_lag_4</span><span class="p">],</span>
                <span class="s2">&quot;sales_lag_5&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">sales_lag_5</span><span class="p">],</span>
                <span class="s2">&quot;sales_lag_6&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">sales_lag_6</span><span class="p">],</span>
                <span class="s2">&quot;sales_diff_1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">sales_diff_1</span><span class="p">],</span>
                <span class="s2">&quot;sales_diff_2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">sales_diff_2</span><span class="p">],</span>
            <span class="p">})</span>
            
            <span class="c1"># Generate the prediction for the current forecast date.</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_fc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fc_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
            
            <span class="c1"># Append the predicted record to the growing window data.</span>
            <span class="c1"># Some features (e.g., temperature/fuel_price/unemployment) may not be available.</span>
            <span class="n">new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">store</span><span class="p">],</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fc_date</span><span class="p">],</span>
                <span class="s2">&quot;weekly_sales&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="s2">&quot;holiday_flag&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;holiday_flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                <span class="s2">&quot;fuel_price&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                <span class="s2">&quot;cpi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">CPI_val</span><span class="p">],</span>
                <span class="s2">&quot;unemployment&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
            <span class="p">})</span>
            <span class="n">data_gw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_gw</span><span class="p">,</span> <span class="n">new_row</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data_gw</span> <span class="o">=</span> <span class="n">data_gw</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Get actual weekly_sales for these forecast dates.</span>
        <span class="n">actual_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fc_date</span> <span class="ow">in</span> <span class="n">fc_dates</span><span class="p">:</span>
            <span class="n">act_row</span> <span class="o">=</span> <span class="n">valid_store_df</span><span class="p">[</span><span class="n">valid_store_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fc_date</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">act_row</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">actual_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act_row</span><span class="p">[</span><span class="s2">&quot;weekly_sales&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">store_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fc_preds</span><span class="p">)</span>
        <span class="n">store_actuals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actual_vals</span><span class="p">)</span>
        <span class="n">forecast_dates_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fc_dates</span><span class="p">)</span>
    

    <span class="n">store_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">,</span> <span class="n">store_predictions</span><span class="p">))</span>
    
    <span class="c1"># Save store results in the results dictionary.</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;XGBoost&quot;</span><span class="p">][</span><span class="s2">&quot;store_results&quot;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;forecast_dates&quot;</span><span class="p">:</span> <span class="n">forecast_dates_list</span><span class="p">,</span>
        <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="n">store_predictions</span><span class="p">,</span>
        <span class="s2">&quot;actuals&quot;</span><span class="p">:</span> <span class="n">store_actuals</span><span class="p">,</span>
        <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="n">store_mae</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="id6">
<h4>Calculate Errors<a class="headerlink" href="#id6" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_mae</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;XGBoost&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">][</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
    <span class="n">all_mae</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_mae</span><span class="p">)</span>

<span class="n">avg_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>
<span class="n">std_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>

<span class="n">results</span><span class="p">[</span><span class="s1">&#39;XGBoost&#39;</span><span class="p">][</span><span class="s1">&#39;aggregated_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;avg_mae&#39;</span><span class="p">:</span> <span class="n">avg_mae</span><span class="p">,</span>
    <span class="s1">&#39;std_mae&#39;</span><span class="p">:</span> <span class="n">std_mae</span>
<span class="p">}</span>

<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_mae</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count        45.000000
mean      71033.110247
std       42442.068225
min       10995.485433
25%       35036.849567
50%       63731.893462
75%       98883.153269
max      194336.745769
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_all_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h4>Visualize Predictions<a class="headerlink" href="#id7" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">actual_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="n">store_result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;XGBoost&quot;</span><span class="p">][</span><span class="s2">&quot;store_results&quot;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">act</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">store_result</span><span class="p">[</span><span class="s2">&quot;forecast_dates&quot;</span><span class="p">],</span>
                             <span class="n">store_result</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">],</span>
                             <span class="n">store_result</span><span class="p">[</span><span class="s2">&quot;actuals&quot;</span><span class="p">]):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>

<span class="c1"># Sort the forecast dates and compute the average across stores.</span>
<span class="n">sorted_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pred_by_date</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">avg_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>
<span class="n">avg_actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_actual</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual Average Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_pred</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted Average Sales (XGBoost)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weekly Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;XGBoost: Actual vs. Predicted Average Weekly Sales (Validation)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/52dae059c910d3a46357b8ad9da0b7b84f62dfbee24ac90dfdd484797664f7e0.png" src="../_images/52dae059c910d3a46357b8ad9da0b7b84f62dfbee24ac90dfdd484797664f7e0.png" />
</div>
</div>
</section>
</section>
<section id="fb-prophet">
<h3>FB Prophet<a class="headerlink" href="#fb-prophet" title="Link to this heading">#</a></h3>
<section id="id8">
<h4>Separate train test split and growing windows<a class="headerlink" href="#id8" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split the 131 weeks: the first 105 weeks for training and the next 26 weeks for validation</span>
<span class="n">train_dates</span> <span class="o">=</span> <span class="n">train_val_dates</span><span class="p">[:</span><span class="mi">105</span><span class="p">]</span>
<span class="n">val_dates</span> <span class="o">=</span> <span class="n">train_val_dates</span><span class="p">[</span><span class="mi">105</span><span class="p">:]</span>

<span class="c1"># We will forecast in 4-week horizons over the 20 validation weeks.</span>
<span class="n">forecast_horizon</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_forecast_iterations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)</span> <span class="o">//</span> <span class="n">forecast_horizon</span>  <span class="c1"># should be 20/2 = 10</span>

<span class="c1"># random_stores = random.sample(stores, 25)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id9">
<h4>Training<a class="headerlink" href="#id9" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;prophet&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;cmdstanpy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">disabled</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize results dictionary for Prophet forecasts.</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">load_all_results</span><span class="p">()</span>

<span class="k">if</span> <span class="s1">&#39;Prophet&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Prophet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;store_results&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;aggregated_metrics&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

<span class="c1"># Get the list of stores (assuming the store column is categorical).</span>
<span class="n">stores</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">holidays</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;holiday_flag&#39;</span><span class="p">]][[</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span>  <span class="c1"># select only rows where holiday_flag is True</span>
    <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>               <span class="c1"># remove duplicate dates if needed</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;ds&#39;</span><span class="p">})</span>
<span class="p">)</span>
<span class="n">holidays</span><span class="p">[</span><span class="s1">&#39;holiday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;holiday&#39;</span>  <span class="c1"># Label each date with a name (could be more specific)</span>
<span class="c1"># Optionally, if you believe the effect spans extra days, add a window:</span>
<span class="n">holidays</span><span class="p">[</span><span class="s1">&#39;lower_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># The holiday&#39;s effect starts one day prior</span>
<span class="n">holidays</span><span class="p">[</span><span class="s1">&#39;upper_window&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># The effect lasts one day after</span>

<span class="c1"># Loop over each store.</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="c1"># --- Data Preparation for Prophet ---</span>
    <span class="c1"># Filter the data for the current store and sort by date.</span>
    <span class="n">store_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;store&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">store</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Split store_df into training and validation based on your date lists.</span>
    <span class="n">train_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_dates</span><span class="p">)]</span>
    <span class="n">valid_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)]</span>
    
    <span class="c1"># Convert to Prophet&#39;s expected format: &quot;ds&quot; (for date) and &quot;y&quot; (for weekly_sales).</span>
    <span class="n">train_prophet</span> <span class="o">=</span> <span class="n">train_store_df</span><span class="p">[[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;weekly_sales&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="s2">&quot;weekly_sales&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">valid_prophet</span> <span class="o">=</span> <span class="n">valid_store_df</span><span class="p">[[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;weekly_sales&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="s2">&quot;weekly_sales&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    
    <span class="c1"># Initialize lists to store forecasts, actuals, and the forecast dates.</span>
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">forecast_dates_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Determine the number of forecast iterations (e.g., for 26 weeks with a 2-week horizon).</span>
    <span class="n">n_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_prophet</span><span class="p">)</span> <span class="o">//</span> <span class="n">forecast_horizon</span>
    <span class="n">valid_dates</span> <span class="o">=</span> <span class="n">valid_prophet</span><span class="p">[</span><span class="s2">&quot;ds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># these should already be sorted</span>
    
    <span class="c1"># Growing-window forecast loop.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_iter</span><span class="p">):</span>
        <span class="c1"># Initialize the Prophet model with appropriate parameters</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">(</span>
            <span class="n">growth</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>                <span class="c1"># Use a linear trend.</span>
            <span class="n">changepoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>              <span class="c1"># Let Prophet automatically pick changepoints.</span>
            <span class="n">n_changepoints</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>              <span class="c1"># Default number of potential changepoints.</span>
            <span class="n">changepoint_range</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>            <span class="c1"># Use the first 80% of the history for changepoint detection.</span>
            <span class="n">yearly_seasonality</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>        <span class="c1"># Include yearly seasonality (important for holidays).</span>
            <span class="n">weekly_seasonality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>        <span class="c1"># Include weekly seasonality (even for weekly data, if relevant).</span>
            <span class="n">daily_seasonality</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>        <span class="c1"># Daily seasonality is not applicable for weekly data.</span>
            <span class="n">holidays</span><span class="o">=</span><span class="n">holidays</span><span class="p">,</span>              <span class="c1"># Pass in your holidays DataFrame.</span>
            <span class="n">seasonality_mode</span><span class="o">=</span><span class="s2">&quot;additive&quot;</span><span class="p">,</span>    <span class="c1"># Use an additive seasonality.</span>
            <span class="n">seasonality_prior_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>   <span class="c1"># Default prior scale for seasonal effects.</span>
            <span class="n">holidays_prior_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>      <span class="c1"># Default prior scale for holiday effects.</span>
            <span class="n">changepoint_prior_scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>   <span class="c1"># Controls the flexibility of trend changepoints.</span>
            <span class="n">mcmc_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>                 <span class="c1"># Use MAP estimation for faster fitting.</span>
            <span class="n">interval_width</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span>            <span class="c1"># 80% prediction intervals.</span>
            <span class="n">uncertainty_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>       <span class="c1"># Number of draws for uncertainty estimation.</span>
            <span class="n">stan_backend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>              <span class="c1"># Automatically select a Stan backend.</span>
            <span class="n">holidays_mode</span><span class="o">=</span><span class="s1">&#39;additive&#39;</span>        <span class="c1"># Use additive holiday effects.</span>
        <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_prophet</span><span class="p">)</span>
        
        <span class="c1"># Determine the current forecast dates from the validation set.</span>
        <span class="n">fc_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_dates</span> <span class="o">=</span> <span class="n">valid_dates</span><span class="p">[</span><span class="n">fc_start</span><span class="p">:</span><span class="n">fc_end</span><span class="p">]</span>
        
        <span class="c1"># Create a &quot;future&quot; dataframe with the forecast dates.</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;ds&quot;</span><span class="p">:</span> <span class="n">fc_dates</span><span class="p">})</span>
        <span class="n">forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">forecast</span><span class="p">[</span><span class="s2">&quot;yhat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Retrieve the actual observed sales for these fc_dates.</span>
        <span class="n">actual_vals</span> <span class="o">=</span> <span class="n">valid_prophet</span><span class="p">[</span><span class="n">valid_prophet</span><span class="p">[</span><span class="s2">&quot;ds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fc_dates</span><span class="p">)][</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Store predictions, actuals, and the associated dates.</span>
        <span class="n">store_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
        <span class="n">store_actuals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actual_vals</span><span class="p">)</span>
        <span class="n">forecast_dates_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fc_dates</span><span class="p">)</span>
        
        <span class="c1"># IMPORTANT: Grow the training set with the ACTUAL observed values from the validation set.</span>
        <span class="n">new_train</span> <span class="o">=</span> <span class="n">valid_prophet</span><span class="p">[</span><span class="n">valid_prophet</span><span class="p">[</span><span class="s2">&quot;ds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fc_dates</span><span class="p">)]</span>
        <span class="n">train_prophet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_prophet</span><span class="p">,</span> <span class="n">new_train</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">,</span> <span class="n">store_predictions</span><span class="p">))</span>
    
    <span class="c1"># Save the store-specific results.</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;Prophet&quot;</span><span class="p">][</span><span class="s2">&quot;store_results&quot;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;forecast_dates&quot;</span><span class="p">:</span> <span class="n">forecast_dates_list</span><span class="p">,</span>
        <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="n">store_predictions</span><span class="p">,</span>
        <span class="s2">&quot;actuals&quot;</span><span class="p">:</span> <span class="n">store_actuals</span><span class="p">,</span>
        <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="n">store_mae</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="id10">
<h4>Calculate Errors<a class="headerlink" href="#id10" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_mae</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Prophet&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">][</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
    <span class="n">all_mae</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_mae</span><span class="p">)</span>

<span class="n">avg_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>
<span class="n">std_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>

<span class="n">results</span><span class="p">[</span><span class="s1">&#39;Prophet&#39;</span><span class="p">][</span><span class="s1">&#39;aggregated_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;avg_mae&#39;</span><span class="p">:</span> <span class="n">avg_mae</span><span class="p">,</span>
    <span class="s1">&#39;std_mae&#39;</span><span class="p">:</span> <span class="n">std_mae</span>
<span class="p">}</span>

<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_mae</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count        45.000000
mean      47723.386355
std       30315.527289
min        8256.784922
25%       28595.507719
50%       39556.643287
75%       63825.478654
max      149736.209768
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_all_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id11">
<h4>Visualize Predictions<a class="headerlink" href="#id11" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aggregate predicted and actual values by forecast date across all stores.</span>
<span class="n">pred_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">actual_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="n">store_result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;Prophet&quot;</span><span class="p">][</span><span class="s2">&quot;store_results&quot;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">act</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">store_result</span><span class="p">[</span><span class="s2">&quot;forecast_dates&quot;</span><span class="p">],</span> 
                             <span class="n">store_result</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">],</span> 
                             <span class="n">store_result</span><span class="p">[</span><span class="s2">&quot;actuals&quot;</span><span class="p">]):</span>
        <span class="c1"># Make sure that the forecast date is a pd.Timestamp.</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>

<span class="c1"># Sort forecast dates.</span>
<span class="n">sorted_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pred_by_date</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># Compute the average prediction and actual sales for each date.</span>
<span class="n">avg_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>
<span class="n">avg_actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_actual</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual Average Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_pred</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted Average Sales (Prophet)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weekly Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;FB Prophet: Actual vs. Predicted Average Weekly Sales (Validation)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/af045a9a92fc58344413c3bb75c7f5f7bdfd292893e7c229c406835fc7b2310e.png" src="../_images/af045a9a92fc58344413c3bb75c7f5f7bdfd292893e7c229c406835fc7b2310e.png" />
</div>
</div>
</section>
</section>
<section id="sarima">
<h3>SARIMA<a class="headerlink" href="#sarima" title="Link to this heading">#</a></h3>
<section id="id12">
<h4>Separate train test split and growing windows<a class="headerlink" href="#id12" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split the 131 weeks: the first 111 weeks for training and the next 20 weeks for validation</span>
<span class="n">train_dates</span> <span class="o">=</span> <span class="n">train_val_dates</span><span class="p">[:</span><span class="mi">105</span><span class="p">]</span>
<span class="n">val_dates</span> <span class="o">=</span> <span class="n">train_val_dates</span><span class="p">[</span><span class="mi">105</span><span class="p">:]</span>

<span class="c1"># We will forecast in 4-week horizons over the 20 validation weeks.</span>
<span class="n">forecast_horizon</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_forecast_iterations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)</span> <span class="o">//</span> <span class="n">forecast_horizon</span>  <span class="c1"># should be 20/2 = 10</span>

<span class="n">random_stores</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">stores</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id13">
<h4>Training<a class="headerlink" href="#id13" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">load_all_results</span><span class="p">()</span>

<span class="k">if</span> <span class="s1">&#39;SARIMA&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SARIMA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;store_results&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;aggregated_metrics&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

<span class="c1"># Define candidate non-seasonal orders for SARIMA</span>
<span class="n">candidate_orders</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span> <span class="c1"># , (6, 1, 5), (6, 2, 4), (6, 2, 5)</span>
<span class="c1"># Fixed seasonal order: (P, D, Q, m)</span>
<span class="n">seasonal_order</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">52</span><span class="p">)</span>

<span class="c1"># Loop over each store</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">random_stores</span><span class="p">:</span>
    <span class="c1"># Filter the store’s data and sort by date</span>
    <span class="n">store_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">store</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Split the store data into training and validation based on date</span>
    <span class="n">train_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_dates</span><span class="p">)]</span>
    <span class="n">valid_store_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)]</span>
    
    <span class="c1"># Convert training data into a time series with date as index</span>
    <span class="n">train_series</span> <span class="o">=</span> <span class="n">train_store_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">]</span>
    
    <span class="c1"># -----------------------------------------------------</span>
    <span class="c1"># Step 1: Model Selection -- Choose Best Non-Seasonal Order</span>
    <span class="c1"># -----------------------------------------------------</span>
    <span class="n">best_aic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_order</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># aic_bic = pd.DataFrame(columns=[&#39;order&#39;, &#39;aic&#39;, &#39;bic&#39;], index = list(range(len(candidate_orders)))) </span>
    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">candidate_orders</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">SARIMAX</span><span class="p">(</span><span class="n">train_series</span><span class="p">,</span>
                                <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                                <span class="n">seasonal_order</span><span class="o">=</span><span class="n">seasonal_order</span><span class="p">,</span>
                                <span class="n">enforce_stationarity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">enforce_invertibility</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">fit_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># aic_bic.iloc[idx][&#39;order&#39;] = order</span>
                <span class="c1"># aic_bic.iloc[idx][&#39;aic&#39;] = fit_model.aic</span>
                <span class="c1"># aic_bic.iloc[idx][&#39;bic&#39;] = fit_model.bic</span>
                <span class="c1"># print(f&quot;For store {store}, order {order}, AIC: {fit_model.aic}, BIC: {fit_model.bic}&quot;)</span>
            <span class="c1"># if fit_model.aic &lt; best_aic:</span>
            <span class="c1">#     best_aic = fit_model.aic</span>
                <span class="n">best_order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Store </span><span class="si">{</span><span class="n">store</span><span class="si">}</span><span class="s2">, SARIMA candidate order </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Store </span><span class="si">{</span><span class="n">store</span><span class="si">}</span><span class="s2"> -- Selected SARIMA order: </span><span class="si">{</span><span class="n">best_order</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Seasonal: </span><span class="si">{</span><span class="n">seasonal_order</span><span class="si">}</span><span class="s2"> (AIC: </span><span class="si">{</span><span class="n">fit_model</span><span class="o">.</span><span class="n">aic</span><span class="si">}</span><span class="s2">) (BIC: </span><span class="si">{</span><span class="n">fit_model</span><span class="o">.</span><span class="n">bic</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="c1"># -----------------------------------------------------</span>
    <span class="c1"># Step 2: Growing-Window Forecast with Selected SARIMA Order</span>
    <span class="c1"># -----------------------------------------------------</span>
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">forecast_dates_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Start with the training series as the initial window</span>
    <span class="n">series_gw</span> <span class="o">=</span> <span class="n">train_series</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Number of forecast iterations (26 weeks / forecast_horizon weeks per forecast)</span>
    <span class="n">n_forecast_iterations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dates</span><span class="p">)</span> <span class="o">//</span> <span class="n">forecast_horizon</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_forecast_iterations</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecast iteration </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">n_forecast_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">model_gw</span> <span class="o">=</span> <span class="n">SARIMAX</span><span class="p">(</span><span class="n">series_gw</span><span class="p">,</span>
                                   <span class="n">order</span><span class="o">=</span><span class="n">best_order</span><span class="p">,</span>
                                   <span class="n">seasonal_order</span><span class="o">=</span><span class="n">seasonal_order</span><span class="p">,</span>
                                   <span class="n">enforce_stationarity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">enforce_invertibility</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">fit_gw</span> <span class="o">=</span> <span class="n">model_gw</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">forecast_result</span> <span class="o">=</span> <span class="n">fit_gw</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">forecast_horizon</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Store </span><span class="si">{</span><span class="n">store</span><span class="si">}</span><span class="s2">: Forecast iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">forecast_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">forecast_horizon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
        <span class="c1"># Identify forecast dates (next 2 weeks from validation dates)</span>
        <span class="n">fc_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">forecast_horizon</span>
        <span class="n">fc_dates</span> <span class="o">=</span> <span class="n">val_dates</span><span class="p">[</span><span class="n">fc_start</span><span class="p">:</span><span class="n">fc_end</span><span class="p">]</span>
    
        <span class="c1"># Get the actual values from the validation set for these dates</span>
        <span class="n">valid_series</span> <span class="o">=</span> <span class="n">valid_store_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">]</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">valid_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fc_dates</span><span class="p">]</span>
    
        <span class="c1"># Append forecasts, actual values, and dates</span>
        <span class="n">store_predictions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">forecast_result</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">forecast_result</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">forecast_result</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">store_actuals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">actual</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">forecast_dates_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fc_dates</span><span class="p">)</span>
    
        <span class="c1"># Update the growing window with the actual values (simulate receiving new data)</span>
        <span class="n">series_gw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">series_gw</span><span class="p">,</span> <span class="n">actual</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    
    <span class="c1"># Compute store-level rmse for SARIMA forecasts</span>
    <span class="n">store_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_actuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">store_actuals</span><span class="p">,</span> <span class="n">store_predictions</span><span class="p">))</span>
    
    <span class="c1"># Save store results in the results dictionary</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SARIMA&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;best_order&#39;</span><span class="p">:</span> <span class="n">best_order</span><span class="p">,</span>
        <span class="s1">&#39;seasonal_order&#39;</span><span class="p">:</span> <span class="n">seasonal_order</span><span class="p">,</span>
        <span class="s1">&#39;forecast_dates&#39;</span><span class="p">:</span> <span class="n">forecast_dates_list</span><span class="p">,</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">store_predictions</span><span class="p">,</span>
        <span class="s1">&#39;actuals&#39;</span><span class="p">:</span> <span class="n">store_actuals</span><span class="p">,</span>
        <span class="s1">&#39;mae&#39;</span><span class="p">:</span> <span class="n">store_mae</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="id14">
<h4>Calculate Errors<a class="headerlink" href="#id14" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_mae</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">random_stores</span><span class="p">:</span>
    <span class="n">store_mae</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SARIMA&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">][</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
    <span class="n">all_mae</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_mae</span><span class="p">)</span>

<span class="n">avg_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>
<span class="n">std_mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_mae</span><span class="p">))</span>

<span class="n">results</span><span class="p">[</span><span class="s1">&#39;SARIMA&#39;</span><span class="p">][</span><span class="s1">&#39;aggregated_metrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;avg_mae&#39;</span><span class="p">:</span> <span class="n">avg_mae</span><span class="p">,</span>
    <span class="s1">&#39;std_mae&#39;</span><span class="p">:</span> <span class="n">std_mae</span>
<span class="p">}</span>

<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_mae</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    25.000000
mean      0.111026
std       0.076609
min       0.030905
25%       0.062593
50%       0.088156
75%       0.132114
max       0.345813
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_all_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id15">
<h4>Visualize Predictions<a class="headerlink" href="#id15" title="Link to this heading">#</a></h4>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aggregate predicted and actual sales by forecast date (across stores).</span>
<span class="n">pred_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">actual_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">random_stores</span><span class="p">:</span>
    <span class="n">store_result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;SARIMA&#39;</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">act</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;forecast_dates&#39;</span><span class="p">],</span>
                             <span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">],</span>
                             <span class="n">store_result</span><span class="p">[</span><span class="s1">&#39;actuals&#39;</span><span class="p">]):</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>

<span class="c1"># Sort forecast dates</span>
<span class="n">sorted_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pred_by_date</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># Compute the average prediction and actual value for each date</span>
<span class="n">avg_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>
<span class="n">avg_actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>

<span class="c1"># Plot the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_actual</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Average Sales&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_pred</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted Average Sales (SARIMA)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weekly Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;SARIMA: Actual vs. Predicted Average Weekly Sales (Validation Period)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/e89c859c55c3f34661d771074059e29332fd467a360059c98e6ca031ce5cedef.png" src="../_images/e89c859c55c3f34661d771074059e29332fd467a360059c98e6ca031ce5cedef.png" />
</div>
</div>
</section>
</section>
</section>
<section id="model-comparison">
<h2>Model Comparison<a class="headerlink" href="#model-comparison" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">load_all_results</span><span class="p">()</span>

<span class="n">comparison</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;25%&#39;</span><span class="p">,</span> <span class="s1">&#39;50%&#39;</span><span class="p">,</span> <span class="s1">&#39;75%&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">],</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">all_mae</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;store_results&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">store_mae</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="s1">&#39;store_results&#39;</span><span class="p">][</span><span class="n">store</span><span class="p">][</span><span class="s1">&#39;mae&#39;</span><span class="p">]</span>
        <span class="n">all_mae</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_mae</span><span class="p">)</span>
    <span class="n">comparison</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_mae</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="n">comparison_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparison</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">comparison_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>HoltWinters</th>
      <th>ARIMA</th>
      <th>XGBoost</th>
      <th>Prophet</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>45</td>
      <td>45</td>
      <td>45</td>
      <td>45</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>42961</td>
      <td>55857</td>
      <td>71033</td>
      <td>47723</td>
    </tr>
    <tr>
      <th>std</th>
      <td>26876</td>
      <td>31973</td>
      <td>42442</td>
      <td>30315</td>
    </tr>
    <tr>
      <th>min</th>
      <td>9307</td>
      <td>8107</td>
      <td>10995</td>
      <td>8256</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>23044</td>
      <td>32722</td>
      <td>35036</td>
      <td>28595</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>37918</td>
      <td>50691</td>
      <td>63731</td>
      <td>39556</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>59191</td>
      <td>85070</td>
      <td>98883</td>
      <td>63825</td>
    </tr>
    <tr>
      <th>max</th>
      <td>126763</td>
      <td>128366</td>
      <td>194336</td>
      <td>149736</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="observations">
<h3>Observations<a class="headerlink" href="#observations" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Comparing the mean and standard deviation of Mean Absolute errors across stores and across growing window forecasts, <strong>Holt-Winters</strong> outperforms all other models. Hence, it will be used for full forecast of the next 12 weeks.</p></li>
<li><p>Prophet comes in second place with slighly worse MAE scores.</p></li>
<li><p>Same with ARIMA, which comes in third place.</p></li>
<li><p>XGBoost is the worst performer with significantly higher MAE scores. However, peculiarly, when looking at the the plot of actual vs. predicted values, XGBoost would have performed extremely well if only it had predicted values one week ahead. Basically, if I shifted the predictions of XGboost by one week, it would have been the best performer.</p></li>
<li><p>Same case can also be observed for other models too, albeit in relatively lesser extent.</p></li>
<li><p>The reason behind this might be the fact that I used 52 weeks as seasonal period of 1 year. But, 52 weeks don’t completely make up 1 year. Combined with the fact that the model trained on 105 weeks (52 + 53), it might have justifyably miscalculated the seasonal effect leading to offset spikes in sales</p></li>
</ul>
</section>
</section>
<section id="final-forecast">
<h2>Final Forecast<a class="headerlink" href="#final-forecast" title="Link to this heading">#</a></h2>
<section id="final-training">
<h3>Final Training<a class="headerlink" href="#final-training" title="Link to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_val_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())[:</span><span class="o">-</span><span class="mi">12</span><span class="p">]</span>  <span class="c1"># first 131 weeks</span>
<span class="n">holdout_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())[</span><span class="o">-</span><span class="mi">12</span><span class="p">:]</span>      <span class="c1"># last 12 weeks</span>

<span class="c1"># Get the list of stores</span>
<span class="n">stores</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Initialize dictionary to collect results per store.</span>
<span class="n">final_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">store_mae_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Also, prepare dictionaries to aggregate predicted and actual sales by date</span>
<span class="n">pred_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="n">actual_by_date</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">stores</span><span class="p">:</span>
    <span class="c1"># Filter store data and sort by date</span>
    <span class="n">store_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">store</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Split the data:</span>
    <span class="c1"># Training + Validation set (131 weeks)</span>
    <span class="n">train_val_df</span> <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_val_dates</span><span class="p">)]</span>
    <span class="c1"># Holdout set (last 12 weeks)</span>
    <span class="n">holdout_df</span>   <span class="o">=</span> <span class="n">store_df</span><span class="p">[</span><span class="n">store_df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">holdout_dates</span><span class="p">)]</span>
    
    <span class="c1"># Set the series for training</span>
    <span class="n">train_val_series</span> <span class="o">=</span> <span class="n">train_val_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">]</span>
    
    <span class="c1"># Fit the Holt Winters model on all 131 weeks.</span>
    <span class="c1"># Here we assume an additive model for level, trend, and season,</span>
    <span class="c1"># with a seasonal_periods of 52 (or adjust if needed)</span>

    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hw_model</span> <span class="o">=</span> <span class="n">ExponentialSmoothing</span><span class="p">(</span>
                <span class="n">train_val_series</span><span class="p">,</span>
                <span class="n">trend</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span>
                <span class="n">seasonal</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span>
                <span class="n">seasonal_periods</span><span class="o">=</span><span class="mi">52</span><span class="p">,</span>
                <span class="n">initialization_method</span><span class="o">=</span><span class="s2">&quot;estimated&quot;</span>
            <span class="p">)</span>
            <span class="n">hw_fit</span> <span class="o">=</span> <span class="n">hw_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">optimized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Store </span><span class="si">{</span><span class="n">store</span><span class="si">}</span><span class="s2">: Model fit failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="c1"># Forecast the next 12 weeks in one go (non rolling)</span>
        <span class="n">forecast_values</span> <span class="o">=</span> <span class="n">hw_fit</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    
    <span class="c1"># Get the actual values from the holdout set, reindex by date for comparison</span>
    <span class="n">holdout_series</span> <span class="o">=</span> <span class="n">holdout_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)[</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">]</span>
    
    <span class="c1"># Align forecast index with holdout dates (if necessary, force index order)</span>
    <span class="n">forecast_values</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">holdout_series</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># Calculate error (RMSE) for the store over the 12-week holdout period.</span>
    <span class="n">store_error</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">holdout_series</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">forecast_values</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">store_mae_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_error</span><span class="p">)</span>
    
    <span class="c1"># Save the store&#39;s forecast results.</span>
    <span class="n">final_results</span><span class="p">[</span><span class="n">store</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;forecast_dates&quot;</span><span class="p">:</span> <span class="n">forecast_values</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s2">&quot;predictions&quot;</span><span class="p">:</span> <span class="n">forecast_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s2">&quot;actuals&quot;</span><span class="p">:</span> <span class="n">holdout_series</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s2">&quot;mae&quot;</span><span class="p">:</span> <span class="n">store_error</span>
    <span class="p">}</span>
    
    <span class="c1"># Aggregate predicted and actual values per date across stores.</span>
    <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">act</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">forecast_values</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">forecast_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">holdout_series</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
        <span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="error-analysis">
<h3>Error Analysis<a class="headerlink" href="#error-analysis" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">store_mae_list</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count        45.000000
mean      39162.829042
std       30738.927290
min        5635.776172
25%       20474.399500
50%       32764.308580
75%       45201.375036
max      145329.783290
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualization-of-results">
<h3>Visualization of Results<a class="headerlink" href="#visualization-of-results" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sorted_dates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pred_by_date</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">avg_pred</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>
<span class="n">avg_actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual_by_date</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">sorted_dates</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_actual</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual Average Sales&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sorted_dates</span><span class="p">,</span> <span class="n">avg_pred</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted Average Sales (Holt Winters)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weekly Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Final Forecast: Actual vs. Predicted Average Weekly Sales (Holdout Period)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5b4c436ee06b55fcb69049416b68ae4e9bfa1d7958e8db0c9c04b185bf73a537.png" src="../_images/5b4c436ee06b55fcb69049416b68ae4e9bfa1d7958e8db0c9c04b185bf73a537.png" />
</div>
</div>
</section>
<section id="id16">
<h3>Observations<a class="headerlink" href="#id16" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>As expected, Holt Winters model does predict the future sales well enough for all 12 weeks at once.</p></li>
<li><p>It’s average MAE for this forecast across all stores was 39162 dollars which is consistent with it’s previous average error rate calculated during model comparison using growing window forecast.</p></li>
<li><p>However, visual inspection shows that the model underpredicted the values 83% of times i.e. for 10 of the 12 weeks.</p></li>
</ol>
</section>
</section>
<section id="todo">
<h2>ToDo<a class="headerlink" href="#todo" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Use Darts libary’s anamoly detector + forecaster to incorporate actual ‘holidays’ events that boost sales in forecasting.</p></li>
<li><p>Analysze residuals. Check the Ljung-Box test for residuals.</p></li>
<li><p>Add another loss metric too?</p></li>
<li><p>Use SHAP to analyse models post training.</p></li>
<li><p>Create results_dict as json convertible object and save it to a file.</p></li>
<li><p>STL and MSTL forecasting.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./main"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="analysis.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="../about/about.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">About This Project</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#importing-libraries-and-dataset">Importing Libraries and Dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#methodology">Methodology</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling">Modeling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation">Evaluation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#different-models">Different models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#saving-and-or-loading-previous-results">Saving and/or loading previous results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-and-eval-split">Train, Test and Eval split</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-metric">Loss metric</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preparation">Data Preparation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-training">Model Training</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#holt-winters">Holt Winters</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-errors">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-predictions">Visualize predictions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arima">ARIMA</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Visualize Predictions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#xgboost">XGBoost</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#separate-train-test-split-and-growing-windows">Separate train test split and growing windows</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Visualize Predictions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fb-prophet">FB Prophet</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Separate train test split and growing windows</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Visualize Predictions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sarima">SARIMA</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Separate train test split and growing windows</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Training</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Calculate Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Visualize Predictions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-comparison">Model Comparison</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-forecast">Final Forecast</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#final-training">Final Training</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#error-analysis">Error Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualization-of-results">Visualization of Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Observations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todo">ToDo</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Aditya Joshi [www.adityajoshi.in]
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>